@page "/registrar"
@using DTO.ControleAcessos
@using Helpers
@inject IJSRuntime JS
@inject NavigationManager Navigation


<div class="flex items-center justify-center min-h-screen bg-gray-100">
    <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
        <h3>Inserir Novo Usuário</h3>
        
        <form>
            <div class="mb-4 bg-gray">
                <label for="nome">Nome:</label>
                <input type="text" class="form-control" id="nome" @bind="usuario.Nome" />
            </div>
            <div class="mb-4 bg-gray">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email" @bind="usuario.Email" />
            </div>
            <div class="mb-6">
                <label for="Senha">Senha:</label>
                <input type="password" class="form-control" id="Senha" @bind="usuario.Senha" />
            </div>
            @if (!string.IsNullOrEmpty(mensagem))
            {
                <div class="alert alert-@(mensagemErro ? "danger" : "success") mt-2">
                    @mensagem
                </div>
            }

            <button type="button" class="btn btn-primary mt-2" @onclick="CriarUsuarioAsync">Criar Usuário</button>
        </form>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    [Parameter]
    public string? RedirecionarCasoSucesso { get; set; }

    private RegistrarUsuarioDTO usuario = new();
    private bool mensagemErro = false;
    private string? mensagem { get; set; }

    protected override void OnInitialized()
    {
        ApiBackend.JsRuntime = JS;
    }

    private async Task CriarUsuarioAsync()
    {
        mensagemErro = false;

        if (string.IsNullOrEmpty(usuario.Email))
        {
            mensagem = "É necessário informar o email.";
            mensagemErro = true;
            this.StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(usuario.Nome))
        {
            mensagem = "É necessário informar o nome.";
            mensagemErro = true;
            this.StateHasChanged();
            return;
        }

        if (string.IsNullOrEmpty(usuario.Senha))
        {
            mensagem = "É necessário informar a senha.";
            mensagemErro = true;
            this.StateHasChanged();
            return;
        }

        try
        {
            var result = await ApiBackend.PostAsync("usuarios", usuario);
            mensagem = $"Usuário '{result.Nome}' criado com sucesso!";
            StateHasChanged();
            await SetTimeout(2000, () => Navigation.NavigateTo("/autenticacao/login"));
        }
        catch (Exception ex)
        {
            mensagem = ex.Message;
            mensagemErro = true;
            this.StateHasChanged();
            return;
        }
    }

    static async Task SetTimeout(int milliseconds, Action action)
    {
        await Task.Delay(milliseconds);
        action();
    }
}